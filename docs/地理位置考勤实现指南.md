# åœ°ç†ä½ç½®è€ƒå‹¤å®ç°æŒ‡å—ï¼ˆé›¶ç¡¬ä»¶æˆæœ¬ï¼‰

## ä¸€ã€æŠ€æœ¯æ–¹æ¡ˆè¯´æ˜

### 1.1 æ— éœ€é¢å¤–ç¡¬ä»¶
- âœ… ä½¿ç”¨å­¦ç”Ÿæ‰‹æœºçš„GPSå®šä½
- âœ… HTML5 Geolocation APIï¼ˆæµè§ˆå™¨å†…ç½®ï¼‰
- âœ… çº¯è½¯ä»¶å®ç°ï¼Œé›¶ç¡¬ä»¶æˆæœ¬
- âœ… æ™®é€šCPUç”µè„‘å®Œå…¨å¤Ÿç”¨

### 1.2 å·¥ä½œåŸç†
```
1. æ•™å¸ˆè®¾ç½®è€ƒå‹¤åœ°ç‚¹ï¼ˆæ•™å®¤/å®éªŒå®¤åæ ‡ï¼‰
2. å­¦ç”Ÿæ‰“å¼€æ‰‹æœºæµè§ˆå™¨ç­¾åˆ°
3. æµè§ˆå™¨è‡ªåŠ¨è·å–GPSä½ç½®
4. åç«¯è®¡ç®—è·ç¦»ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨èŒƒå›´å†…
5. è®°å½•è€ƒå‹¤ç»“æœ
```

### 1.3 è®¡ç®—è·ç¦»å…¬å¼
ä½¿ç”¨ **Haversineå…¬å¼** è®¡ç®—ä¸¤ç‚¹è·ç¦»ï¼ˆçº¯æ•°å­¦è®¡ç®—ï¼Œæ— éœ€APIï¼‰

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 ä¿®æ”¹æ¨¡å‹
```python
# main_app/models.py

from math import radians, cos, sin, asin, sqrt

class Attendance(models.Model):
    session = models.ForeignKey(Session, on_delete=models.DO_NOTHING)
    subject = models.ForeignKey(Subject, on_delete=models.DO_NOTHING)
    date = models.DateField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # æ–°å¢ï¼šåœ°ç†ä½ç½®è€ƒå‹¤å­—æ®µ
    require_location = models.BooleanField(default=False)  # æ˜¯å¦å¯ç”¨ä½ç½®è€ƒå‹¤
    latitude = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)
    longitude = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)
    allowed_radius = models.IntegerField(default=100)  # å…è®¸èŒƒå›´ï¼ˆç±³ï¼‰
    location_name = models.CharField(max_length=200, blank=True)  # åœ°ç‚¹åç§°


class AttendanceReport(models.Model):
    student = models.ForeignKey(Student, on_delete=models.DO_NOTHING)
    attendance = models.ForeignKey(Attendance, on_delete=models.CASCADE)
    status = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # æ–°å¢ï¼šå­¦ç”Ÿç­¾åˆ°ä½ç½®
    check_in_latitude = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)
    check_in_longitude = models.DecimalField(max_digits=9, decimal_places=6, null=True, blank=True)
    distance = models.FloatField(null=True, blank=True)  # è·ç¦»è€ƒå‹¤ç‚¹çš„è·ç¦»ï¼ˆç±³ï¼‰
    is_valid_location = models.BooleanField(default=True)  # ä½ç½®æ˜¯å¦æœ‰æ•ˆ
    
    def calculate_distance(self, lat1, lon1, lat2, lon2):
        """
        è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆHaversineå…¬å¼ï¼‰
        è¿”å›è·ç¦»ï¼ˆç±³ï¼‰
        """
        # è½¬æ¢ä¸ºå¼§åº¦
        lat1, lon1, lat2, lon2 = map(radians, [lat1, lon1, lat2, lon2])
        
        # Haversineå…¬å¼
        dlat = lat2 - lat1
        dlon = lon2 - lon1
        a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
        c = 2 * asin(sqrt(a))
        
        # åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
        r = 6371000
        
        return c * r
```

### 2.2 åˆ›å»ºè¿ç§»æ–‡ä»¶
```bash
python manage.py makemigrations
python manage.py migrate
```

## ä¸‰ã€åç«¯å®ç°

### 3.1 æ•™å¸ˆåˆ›å»ºè€ƒå‹¤ï¼ˆè®¾ç½®åœ°ç‚¹ï¼‰
```python
# main_app/staff_views.py

from django.contrib.auth.decorators import login_required
from django.shortcuts import render, redirect
from django.contrib import messages
from .models import Attendance, Subject, Session
import json

@login_required
def staff_take_attendance(request):
    """æ•™å¸ˆå‘èµ·è€ƒå‹¤"""
    staff = request.user.staff
    subjects = Subject.objects.filter(staff=staff)
    sessions = Session.objects.all()
    
    if request.method == 'POST':
        subject_id = request.POST.get('subject')
        session_id = request.POST.get('session')
        date = request.POST.get('date')
        
        # åœ°ç†ä½ç½®è€ƒå‹¤å‚æ•°
        require_location = request.POST.get('require_location') == 'on'
        latitude = request.POST.get('latitude')
        longitude = request.POST.get('longitude')
        allowed_radius = request.POST.get('allowed_radius', 100)
        location_name = request.POST.get('location_name', '')
        
        try:
            subject = Subject.objects.get(id=subject_id)
            session = Session.objects.get(id=session_id)
            
            attendance = Attendance.objects.create(
                subject=subject,
                session=session,
                date=date,
                require_location=require_location,
                latitude=latitude if require_location else None,
                longitude=longitude if require_location else None,
                allowed_radius=allowed_radius,
                location_name=location_name
            )
            
            messages.success(request, 'è€ƒå‹¤åˆ›å»ºæˆåŠŸï¼')
            return redirect('staff_take_attendance')
            
        except Exception as e:
            messages.error(request, f'åˆ›å»ºå¤±è´¥: {str(e)}')
    
    context = {
        'subjects': subjects,
        'sessions': sessions,
        'page_title': 'å‘èµ·è€ƒå‹¤'
    }
    return render(request, 'staff_template/staff_take_attendance.html', context)
```

### 3.2 å­¦ç”Ÿç­¾åˆ°ï¼ˆæäº¤ä½ç½®ï¼‰
```python
# main_app/student_views.py

from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json

@login_required
@csrf_exempt
def student_check_in(request):
    """å­¦ç”Ÿç­¾åˆ°"""
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            attendance_id = data.get('attendance_id')
            latitude = float(data.get('latitude'))
            longitude = float(data.get('longitude'))
            
            student = request.user.student
            attendance = Attendance.objects.get(id=attendance_id)
            
            # æ£€æŸ¥æ˜¯å¦å·²ç­¾åˆ°
            existing = AttendanceReport.objects.filter(
                student=student,
                attendance=attendance
            ).first()
            
            if existing:
                return JsonResponse({
                    'success': False,
                    'message': 'æ‚¨å·²ç­¾åˆ°è¿‡äº†'
                })
            
            # åˆ›å»ºè€ƒå‹¤è®°å½•
            report = AttendanceReport.objects.create(
                student=student,
                attendance=attendance,
                check_in_latitude=latitude,
                check_in_longitude=longitude,
                status=True
            )
            
            # å¦‚æœå¯ç”¨äº†ä½ç½®éªŒè¯
            if attendance.require_location:
                distance = report.calculate_distance(
                    float(attendance.latitude),
                    float(attendance.longitude),
                    latitude,
                    longitude
                )
                
                report.distance = distance
                report.is_valid_location = distance <= attendance.allowed_radius
                report.save()
                
                if not report.is_valid_location:
                    return JsonResponse({
                        'success': False,
                        'message': f'ç­¾åˆ°å¤±è´¥ï¼šæ‚¨è·ç¦»è€ƒå‹¤ç‚¹ {distance:.0f} ç±³ï¼Œè¶…å‡ºå…è®¸èŒƒå›´',
                        'distance': distance,
                        'allowed_radius': attendance.allowed_radius
                    })
            
            return JsonResponse({
                'success': True,
                'message': 'ç­¾åˆ°æˆåŠŸï¼',
                'distance': report.distance if attendance.require_location else None
            })
            
        except Attendance.DoesNotExist:
            return JsonResponse({'success': False, 'message': 'è€ƒå‹¤ä¸å­˜åœ¨'})
        except Exception as e:
            return JsonResponse({'success': False, 'message': str(e)})
    
    return JsonResponse({'success': False, 'message': 'æ— æ•ˆè¯·æ±‚'})


@login_required
def student_view_attendance(request):
    """å­¦ç”ŸæŸ¥çœ‹å¯ç­¾åˆ°çš„è€ƒå‹¤"""
    student = request.user.student
    from datetime import date
    
    # è·å–ä»Šå¤©çš„è€ƒå‹¤
    today_attendances = Attendance.objects.filter(
        date=date.today(),
        subject__course=student.course
    )
    
    # æ£€æŸ¥å“ªäº›å·²ç­¾åˆ°
    attendance_list = []
    for att in today_attendances:
        report = AttendanceReport.objects.filter(
            student=student,
            attendance=att
        ).first()
        
        attendance_list.append({
            'id': att.id,
            'subject': att.subject.name,
            'require_location': att.require_location,
            'location_name': att.location_name,
            'allowed_radius': att.allowed_radius,
            'checked_in': report is not None,
            'distance': report.distance if report else None,
            'is_valid': report.is_valid_location if report else None
        })
    
    context = {
        'attendances': attendance_list,
        'page_title': 'ä»Šæ—¥è€ƒå‹¤'
    }
    return render(request, 'student_template/student_attendance.html', context)
```

## å››ã€å‰ç«¯å®ç°

### 4.1 æ•™å¸ˆåˆ›å»ºè€ƒå‹¤é¡µé¢
```html
<!-- templates/staff_template/staff_take_attendance.html -->

{% extends 'main_app/base.html' %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h3>å‘èµ·è€ƒå‹¤</h3>
    </div>
    <div class="card-body">
        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label>ç§‘ç›®</label>
                <select name="subject" class="form-control" required>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>å­¦æœŸ</label>
                <select name="session" class="form-control" required>
                    {% for session in sessions %}
                    <option value="{{ session.id }}">{{ session }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" name="date" class="form-control" required>
            </div>
            
            <div class="form-group">
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="requireLocation" 
                           name="require_location" onchange="toggleLocationFields()">
                    <label class="custom-control-label" for="requireLocation">
                        å¯ç”¨åœ°ç†ä½ç½®è€ƒå‹¤
                    </label>
                </div>
            </div>
            
            <div id="locationFields" style="display: none;">
                <div class="alert alert-info">
                    <strong>æç¤ºï¼š</strong>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–å½“å‰ä½ç½®ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥åæ ‡
                </div>
                
                <button type="button" class="btn btn-info mb-3" onclick="getCurrentLocation()">
                    ğŸ“ è·å–å½“å‰ä½ç½®
                </button>
                
                <div class="form-group">
                    <label>åœ°ç‚¹åç§°</label>
                    <input type="text" name="location_name" id="locationName" 
                           class="form-control" placeholder="ä¾‹å¦‚ï¼šæ•™å­¦æ¥¼A101">
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>çº¬åº¦</label>
                            <input type="text" name="latitude" id="latitude" 
                                   class="form-control" placeholder="39.908823" readonly>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>ç»åº¦</label>
                            <input type="text" name="longitude" id="longitude" 
                                   class="form-control" placeholder="116.397470" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å…è®¸èŒƒå›´ï¼ˆç±³ï¼‰</label>
                    <input type="number" name="allowed_radius" class="form-control" 
                           value="100" min="10" max="1000">
                    <small class="form-text text-muted">
                        å­¦ç”Ÿç­¾åˆ°æ—¶è·ç¦»è€ƒå‹¤ç‚¹çš„æœ€å¤§å…è®¸è·ç¦»
                    </small>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">åˆ›å»ºè€ƒå‹¤</button>
        </form>
    </div>
</div>

<script>
function toggleLocationFields() {
    const checkbox = document.getElementById('requireLocation');
    const fields = document.getElementById('locationFields');
    fields.style.display = checkbox.checked ? 'block' : 'none';
}

function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'æ­£åœ¨è·å–ä½ç½®...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
            document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
            
            btn.disabled = false;
            btn.textContent = 'âœ“ ä½ç½®å·²è·å–';
            btn.classList.remove('btn-info');
            btn.classList.add('btn-success');
            
            alert(`ä½ç½®è·å–æˆåŠŸï¼\nç²¾åº¦: ${position.coords.accuracy.toFixed(0)} ç±³`);
        },
        function(error) {
            btn.disabled = false;
            btn.textContent = 'ğŸ“ è·å–å½“å‰ä½ç½®';
            
            let message = 'è·å–ä½ç½®å¤±è´¥ï¼š';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'ç”¨æˆ·æ‹’ç»äº†ä½ç½®è¯·æ±‚';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                    break;
                case error.TIMEOUT:
                    message += 'è¯·æ±‚è¶…æ—¶';
                    break;
            }
            alert(message);
        },
        {
            enableHighAccuracy: true,  // é«˜ç²¾åº¦
            timeout: 10000,            // 10ç§’è¶…æ—¶
            maximumAge: 0              // ä¸ä½¿ç”¨ç¼“å­˜
        }
    );
}
</script>
{% endblock %}
```

### 4.2 å­¦ç”Ÿç­¾åˆ°é¡µé¢
```html
<!-- templates/student_template/student_attendance.html -->

{% extends 'main_app/base.html' %}
{% block content %}
<div class="card">
    <div class="card-header">
        <h3>ä»Šæ—¥è€ƒå‹¤</h3>
    </div>
    <div class="card-body">
        {% if attendances %}
        <div class="list-group">
            {% for att in attendances %}
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>{{ att.subject }}</h5>
                        {% if att.require_location %}
                        <small class="text-muted">
                            ğŸ“ {{ att.location_name }} (èŒƒå›´: {{ att.allowed_radius }}ç±³)
                        </small>
                        {% endif %}
                    </div>
                    
                    <div>
                        {% if att.checked_in %}
                            {% if att.is_valid %}
                            <span class="badge badge-success">âœ“ å·²ç­¾åˆ°</span>
                            {% if att.distance %}
                            <small class="text-muted d-block">
                                è·ç¦»: {{ att.distance|floatformat:0 }}ç±³
                            </small>
                            {% endif %}
                            {% else %}
                            <span class="badge badge-warning">âš  ä½ç½®å¼‚å¸¸</span>
                            <small class="text-danger d-block">
                                è·ç¦»: {{ att.distance|floatformat:0 }}ç±³
                            </small>
                            {% endif %}
                        {% else %}
                        <button class="btn btn-primary" 
                                onclick="checkIn({{ att.id }}, {{ att.require_location|lower }})">
                            ç­¾åˆ°
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-muted">ä»Šå¤©æ²¡æœ‰è€ƒå‹¤</p>
        {% endif %}
    </div>
</div>

<script>
function checkIn(attendanceId, requireLocation) {
    if (!requireLocation) {
        // æ™®é€šç­¾åˆ°ï¼ˆæ— éœ€ä½ç½®ï¼‰
        submitCheckIn(attendanceId, null, null);
        return;
    }
    
    // åœ°ç†ä½ç½®ç­¾åˆ°
    if (!navigator.geolocation) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½ï¼Œæ— æ³•ç­¾åˆ°');
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'æ­£åœ¨è·å–ä½ç½®...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            submitCheckIn(
                attendanceId,
                position.coords.latitude,
                position.coords.longitude
            );
        },
        function(error) {
            btn.disabled = false;
            btn.textContent = 'ç­¾åˆ°';
            
            let message = 'è·å–ä½ç½®å¤±è´¥ï¼Œæ— æ³•ç­¾åˆ°ï¼š\n';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'è¯·å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥GPSæ˜¯å¦å¼€å¯';
                    break;
                case error.TIMEOUT:
                    message += 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                    break;
            }
            alert(message);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

function submitCheckIn(attendanceId, latitude, longitude) {
    fetch('/student-check-in/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            attendance_id: attendanceId,
            latitude: latitude,
            longitude: longitude
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => {
        alert('ç­¾åˆ°å¤±è´¥ï¼š' + error);
        location.reload();
    });
}
</script>
{% endblock %}
```

## äº”ã€URLé…ç½®

```python
# main_app/urls.py

urlpatterns = [
    # ... ç°æœ‰è·¯ç”±
    
    # å­¦ç”Ÿè€ƒå‹¤
    path('student-attendance/', student_views.student_view_attendance, name='student_attendance'),
    path('student-check-in/', student_views.student_check_in, name='student_check_in'),
]
```

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 è®¡ç®—ä¼˜åŒ–
```python
# è·ç¦»è®¡ç®—å¯ä»¥ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
from django.core.cache import cache

def get_distance(lat1, lon1, lat2, lon2):
    cache_key = f'distance_{lat1}_{lon1}_{lat2}_{lon2}'
    distance = cache.get(cache_key)
    if distance is None:
        distance = calculate_distance(lat1, lon1, lat2, lon2)
        cache.set(cache_key, distance, 3600)  # ç¼“å­˜1å°æ—¶
    return distance
```

### 6.2 æ•°æ®åº“ç´¢å¼•
```python
class AttendanceReport(models.Model):
    # ...
    class Meta:
        indexes = [
            models.Index(fields=['student', 'attendance']),
            models.Index(fields=['is_valid_location']),
        ]
```

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: å®šä½ä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ
**A:** 
- å»ºè®®å…è®¸èŒƒå›´è®¾ç½®ä¸º 100-200ç±³
- ä½¿ç”¨ `enableHighAccuracy: true` æé«˜ç²¾åº¦
- å®¤å†…å®šä½è¯¯å·®è¾ƒå¤§ï¼Œå»ºè®®æˆ·å¤–ä½¿ç”¨

### Q2: å­¦ç”Ÿå¯ä»¥ä¼ªé€ ä½ç½®å—ï¼Ÿ
**A:**
- æŠ€æœ¯ä¸Šå¯ä»¥ï¼ˆéœ€è¦root/è¶Šç‹±ï¼‰
- å»ºè®®é…åˆå…¶ä»–éªŒè¯ï¼ˆäººè„¸è¯†åˆ«ã€éšæœºæŠ½æŸ¥ï¼‰
- è®°å½•å¼‚å¸¸ç­¾åˆ°ï¼Œäººå·¥å®¡æ ¸

### Q3: æ²¡æœ‰GPSçš„ç”µè„‘èƒ½ç”¨å—ï¼Ÿ
**A:**
- ç”µè„‘å¯ä»¥é€šè¿‡IPå®šä½ï¼ˆç²¾åº¦ä½ï¼‰
- å»ºè®®å­¦ç”Ÿä½¿ç”¨æ‰‹æœºç­¾åˆ°
- æ•™å¸ˆåˆ›å»ºè€ƒå‹¤æ—¶å¯ä»¥æ‰‹åŠ¨è¾“å…¥åæ ‡

## å…«ã€æˆæœ¬æ€»ç»“

| é¡¹ç›® | æˆæœ¬ |
|------|------|
| ç¡¬ä»¶ | Â¥0ï¼ˆä½¿ç”¨å­¦ç”Ÿæ‰‹æœºï¼‰ |
| è½¯ä»¶ | Â¥0ï¼ˆå¼€æºæŠ€æœ¯ï¼‰ |
| API | Â¥0ï¼ˆæ— éœ€ç¬¬ä¸‰æ–¹APIï¼‰ |
| æœåŠ¡å™¨ | ç°æœ‰æœåŠ¡å™¨å³å¯ |
| **æ€»è®¡** | **Â¥0** |

## ä¹ã€ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. æ·»åŠ åœ°å›¾æ˜¾ç¤ºï¼ˆå¯é€‰ï¼Œä½¿ç”¨å…è´¹çš„é«˜å¾·/ç™¾åº¦åœ°å›¾ï¼‰
2. ç­¾åˆ°å†å²è½¨è¿¹è®°å½•
3. å¼‚å¸¸ç­¾åˆ°é¢„è­¦
4. æ‰¹é‡å¯¼å‡ºè€ƒå‹¤æŠ¥è¡¨
